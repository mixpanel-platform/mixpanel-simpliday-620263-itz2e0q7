<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1348.17">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype html&gt;</p>
<p class="p1">&lt;html&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">     </span>#run {</p>
<p class="p1"><span class="Apple-converted-space">        </span>margin-top:5px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>float:left;</p>
<p class="p1"><span class="Apple-converted-space">        </span>clear:both;</p>
<p class="p1"><span class="Apple-converted-space">        </span>padding: 6px 12px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>background-color: #61adf0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>background-image: -webkit-linear-gradient(#6ab5f2,#53a0ee);</p>
<p class="p1"><span class="Apple-converted-space">        </span>background-image: linear-gradient(#6ab5f2,#53a0ee);</p>
<p class="p1"><span class="Apple-converted-space">        </span>box-shadow: inset 0 1px 1px #77bdf4,0 2px 2px -1px rgba(0,0,0,0.2);</p>
<p class="p1"><span class="Apple-converted-space">        </span>text-transform: uppercase;</p>
<p class="p1"><span class="Apple-converted-space">        </span>border: 1px solid #4d93d7;</p>
<p class="p1"><span class="Apple-converted-space">        </span>color: #fff;</p>
<p class="p1"><span class="Apple-converted-space">        </span>text-shadow: 0 -1px 0 rgba(0,0,0,0.2);</p>
<p class="p1"><span class="Apple-converted-space">        </span>border-radius: 3px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">        </span>font-weight: bold;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>.node circle {</p>
<p class="p1"><span class="Apple-converted-space">        </span>fill: #fff;</p>
<p class="p1"><span class="Apple-converted-space">        </span>stroke: steelblue;</p>
<p class="p1"><span class="Apple-converted-space">        </span>stroke-width: 1.5px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}se</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>.node {</p>
<p class="p1"><span class="Apple-converted-space">        </span>font: 10px sans-serif;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>.link {</p>
<p class="p1"><span class="Apple-converted-space">        </span>fill: none;</p>
<p class="p1"><span class="Apple-converted-space">        </span>stroke: steelblue;</p>
<p class="p1"><span class="Apple-converted-space">        </span>stroke-linecap: round;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/head&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;body class="mixpanel-platform-body" style="overflow-x:scroll;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="eventSelect" style="float: left;"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="dateSelect" style="float: right;"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div style="clear: both;"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;button id="run" value="Run" style="display: none;"&gt;Run&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>MP.api.MAX_SIMULTANEOUS_QUERIES = 30</p>
<p class="p1"><span class="Apple-converted-space">      </span>var datesSelector = $('#dateSelect').MPDatepicker();</p>
<p class="p1"><span class="Apple-converted-space">      </span>var rootEventSelect = $('#eventSelect').MPEventSelect();</p>
<p class="p1"><span class="Apple-converted-space">      </span>/* Global Event List */</p>
<p class="p1"><span class="Apple-converted-space">      </span>var rootEvent;</p>
<p class="p1"><span class="Apple-converted-space">      </span>var objs = {};</p>
<p class="p1"><span class="Apple-converted-space">      </span>var graphData = {}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>var params = {</p>
<p class="p1"><span class="Apple-converted-space">        </span>from: moment().subtract(30, 'days'),</p>
<p class="p1"><span class="Apple-converted-space">        </span>to: moment(),</p>
<p class="p1"><span class="Apple-converted-space">        </span>length: 14,</p>
<p class="p1"><span class="Apple-converted-space">        </span>limit: 200,</p>
<p class="p1"><span class="Apple-converted-space">        </span>interval: 90</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>var width = 960;</p>
<p class="p1"><span class="Apple-converted-space">      </span>var height = 750;</p>
<p class="p1"><span class="Apple-converted-space">      </span>var cluster = d3.layout.cluster()</p>
<p class="p1"><span class="Apple-converted-space">        </span>.size([height, width - 160]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>var diagonal = d3.svg.diagonal()</p>
<p class="p1"><span class="Apple-converted-space">        </span>.projection(function(d) { return [d.y, d.x]; });</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>var svg = d3.select("body").append("svg")</p>
<p class="p1"><span class="Apple-converted-space">        </span>.attr("width", width)</p>
<p class="p1"><span class="Apple-converted-space">        </span>.attr("height", height)</p>
<p class="p1"><span class="Apple-converted-space">        </span>.call(d3.behavior.zoom().on("zoom", function () {</p>
<p class="p1"><span class="Apple-converted-space">                </span>svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")</p>
<p class="p1"><span class="Apple-converted-space">              </span>})</p>
<p class="p1"><span class="Apple-converted-space">            </span>)</p>
<p class="p1"><span class="Apple-converted-space">        </span>.append("g")</p>
<p class="p1"><span class="Apple-converted-space">        </span>.attr("transform", "translate(40,0)");</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>function addNode(data){</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>d3.selectAll(".text").remove();</p>
<p class="p1"><span class="Apple-converted-space">        </span>d3.selectAll(".node").remove();</p>
<p class="p1"><span class="Apple-converted-space">        </span>d3.selectAll(".link").remove();</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>var nodes = cluster.nodes(data),</p>
<p class="p1"><span class="Apple-converted-space">          </span>links = cluster.links(nodes);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>nodes.forEach(function(d) { d.y = d.depth * 180; });</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>var allLinks = svg.selectAll(".link").data(links);</p>
<p class="p1"><span class="Apple-converted-space">        </span>var link = allLinks.enter().append("path")</p>
<p class="p1"><span class="Apple-converted-space">          </span>.attr("class", "link")</p>
<p class="p1"><span class="Apple-converted-space">          </span>.style('stroke-width', function(d) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>return ( d.target.root * .2 );</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>allLinks.transition().duration(1000).attr("d", diagonal);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>var allNodes = svg.selectAll(".node").data(nodes);</p>
<p class="p1"><span class="Apple-converted-space">        </span>var node = allNodes.enter().append("g")</p>
<p class="p1"><span class="Apple-converted-space">          </span>.attr("class", "node")</p>
<p class="p1"><span class="Apple-converted-space">          </span>.attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })</p>
<p class="p1"><span class="Apple-converted-space">          </span>.style('cursor','pointer')</p>
<p class="p1"><span class="Apple-converted-space">          </span>.style('opacity', 0.6)</p>
<p class="p1"><span class="Apple-converted-space">          </span>.on('mouseover', function(d){</p>
<p class="p1"><span class="Apple-converted-space">              </span>d3.select(this).style('opacity', 1.0)</p>
<p class="p1"><span class="Apple-converted-space">              </span>d3.select("text").style('opacity', 1.0);</p>
<p class="p1"><span class="Apple-converted-space">          </span>})</p>
<p class="p1"><span class="Apple-converted-space">          </span>.on('mouseout', function(d){</p>
<p class="p1"><span class="Apple-converted-space">            </span>d3.select(this).style('opacity', 0.6)</p>
<p class="p1"><span class="Apple-converted-space">          </span>})</p>
<p class="p1"><span class="Apple-converted-space">          </span>.on('click', function(val){</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log (val)</p>
<p class="p1"><span class="Apple-converted-space">              </span>if (val.children) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>val._children = val.children;</p>
<p class="p1"><span class="Apple-converted-space">                </span>val.children = null;</p>
<p class="p1"><span class="Apple-converted-space">                </span>addNode(graphData)</p>
<p class="p1"><span class="Apple-converted-space">              </span>} else if (val._children) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>val.children = val._children;</p>
<p class="p1"><span class="Apple-converted-space">                </span>addNode(graphData);</p>
<p class="p1"><span class="Apple-converted-space">              </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>val._children = true ;</p>
<p class="p1"><span class="Apple-converted-space">                </span>nodeQuery(objs, val);</p>
<p class="p1"><span class="Apple-converted-space">              </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>node.append('svg:title')</p>
<p class="p1"><span class="Apple-converted-space">          </span>.text(function(d) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>var count = 'Count: ' + String(d.count) + '\n';</p>
<p class="p1"><span class="Apple-converted-space">            </span>var parent = 'Conversion From Parent Event: ' + String(d.conversion) + '%\n';</p>
<p class="p1"><span class="Apple-converted-space">            </span>var root = 'Conversion From Root Event: ' + String(d.root) + '%';</p>
<p class="p1"><span class="Apple-converted-space">            </span>return count + parent + root });</p>
<p class="p1"><span class="Apple-converted-space">        </span>node.append("circle")</p>
<p class="p1"><span class="Apple-converted-space">            </span>.attr("r", 4.5);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>node.append("text")</p>
<p class="p1"><span class="Apple-converted-space">          </span>.attr("dx", function(d) { return d.children ? 0 : 8; })</p>
<p class="p1"><span class="Apple-converted-space">          </span>.attr("dy", function(d) { return d.children ? 18 : 3; })</p>
<p class="p1"><span class="Apple-converted-space">          </span>.text(function(d) { return d.name; })</p>
<p class="p1"><span class="Apple-converted-space">          </span>.attr("text-anchor", function(d){</p>
<p class="p1"><span class="Apple-converted-space">            </span>return ( d.children ? "middle" : undefined );</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>/* Let the Funnel Queries Begin... */</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>var nodeQuery = function(event_list, node){</p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Dict with top counts for each event */</p>
<p class="p1"><span class="Apple-converted-space">        </span>var nodes = {};</p>
<p class="p1"><span class="Apple-converted-space">        </span>var promises = []</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>_.each(_.keys(event_list), function(key) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>var event = event_list[key];</p>
<p class="p1"><span class="Apple-converted-space">          </span>var parent = node;</p>
<p class="p1"><span class="Apple-converted-space">          </span>var selector_str;</p>
<p class="p1"><span class="Apple-converted-space">          </span>var events = [];</p>
<p class="p1"><span class="Apple-converted-space">          </span>while (parent){</p>
<p class="p1"><span class="Apple-converted-space">            </span>events.push({'event': event});</p>
<p class="p1"><span class="Apple-converted-space">            </span>event = parent.name</p>
<p class="p1"><span class="Apple-converted-space">            </span>parent = parent.parent</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>events.push({'event': event});</p>
<p class="p1"><span class="Apple-converted-space">          </span>events.reverse();</p>
<p class="p1"><span class="Apple-converted-space">          </span>events.push(params);</p>
<p class="p1"><span class="Apple-converted-space">          </span>promises.push(MP.api.funnel.apply(MP.api, events));</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>Promise.all(promises).then(function(promiseArray){</p>
<p class="p1"><span class="Apple-converted-space">            </span>_.each(promiseArray, function(data){</p>
<p class="p1"><span class="Apple-converted-space">                </span>total = 0;</p>
<p class="p1"><span class="Apple-converted-space">                </span>var length = data.length - 1;</p>
<p class="p1"><span class="Apple-converted-space">                </span>_.each(_.values(data[length]), function(funnelObj){ total += funnelObj.count });</p>
<p class="p1"><span class="Apple-converted-space">                </span>nodes[_.values(data[length])[0].event] = total;</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">          </span>}).then(function(){</p>
<p class="p1"><span class="Apple-converted-space">             </span>/* Add Data to Graph Data */</p>
<p class="p1"><span class="Apple-converted-space">             </span>var total = _.values(nodes).reduce(function(a , b){return a + b;});</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">             </span>_.each(_.keys(nodes), function(key){</p>
<p class="p1"><span class="Apple-converted-space">               </span>/*</p>
<p class="p1"><span class="Apple-converted-space">                  </span>Build a node object with the conversion percentage and other meta data and add it to the children</p>
<p class="p1"><span class="Apple-converted-space">                  </span>of the parent node</p>
<p class="p1"><span class="Apple-converted-space">               </span>*/</p>
<p class="p1"><span class="Apple-converted-space">                </span>var conversion = Math.floor(nodes[key] / node.count * 100);</p>
<p class="p1"><span class="Apple-converted-space">                </span>var root = Math.floor(nodes[key] / graphData.count * 100);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (conversion &lt; 2 ) { return };</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (node.children) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>node.children.push({</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'name':key,</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'root': root,</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'conversion': conversion,</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'count':nodes[key]</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>node.children = [{</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'name':key,</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'root': root,</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'conversion': conversion,</p>
<p class="p1"><span class="Apple-converted-space">                      </span>'count':nodes[key]</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}];</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">             </span>})</p>
<p class="p1"><span class="Apple-converted-space">             </span>addNode(graphData);</p>
<p class="p1"><span class="Apple-converted-space">             </span>console.log(graphData)</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>rootEventSelect.on('change', function(e){</p>
<p class="p1"><span class="Apple-converted-space">        </span>$('#run').show();</p>
<p class="p1"><span class="Apple-converted-space">      </span>})</p>
<p class="p1"><span class="Apple-converted-space">      </span>$('#run').on('click', function(e){</p>
<p class="p1"><span class="Apple-converted-space">        </span>var rootEvent = rootEventSelect.MPEventSelect('value')</p>
<p class="p1"><span class="Apple-converted-space">        </span>var dates = datesSelector.MPDatepicker('value')</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>params.from = dates.from;</p>
<p class="p1"><span class="Apple-converted-space">        </span>params.to = dates.to;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* This Event Represents the Origin of the User Flow Diagram. */</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>graphData = {</p>
<p class="p1"><span class="Apple-converted-space">          </span>'name': rootEvent,</p>
<p class="p1"><span class="Apple-converted-space">          </span>'conversion': 100,</p>
<p class="p1"><span class="Apple-converted-space">          </span>'root': 100,</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>var rootParams = {</p>
<p class="p1"><span class="Apple-converted-space">          </span>from: params.from,</p>
<p class="p1"><span class="Apple-converted-space">          </span>to: params.to,</p>
<p class="p1"><span class="Apple-converted-space">          </span>type: 'unique',</p>
<p class="p1"><span class="Apple-converted-space">          </span>interval: 32,</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Top Event Queries */</p>
<p class="p1"><span class="Apple-converted-space">        </span>var topEventsParams = {'limit':'30'};</p>
<p class="p1"><span class="Apple-converted-space">        </span>var topEvents = MP.api.topEvents(topEventsParams);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Funnel Queries */</p>
<p class="p1"><span class="Apple-converted-space">        </span>$.when(topEvents).done(function(events){</p>
<p class="p1"><span class="Apple-converted-space">            </span>objs = events.values();</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>/* Find the Root Event Count */</p>
<p class="p1"><span class="Apple-converted-space">        </span>var rootEventCount = MP.api.segment(rootEvent,rootParams);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>$.when(rootEventCount).done(function(eventCount){</p>
<p class="p1"><span class="Apple-converted-space">            </span>graphData.count = eventCount.sum().values()[rootEvent];</p>
<p class="p1"><span class="Apple-converted-space">            </span>addNode(graphData);</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>

